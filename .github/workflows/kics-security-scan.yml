name: KICS Security Scan

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

# Required permissions for SARIF upload
permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  kics-scan:
    runs-on: ubuntu-latest
    name: KICS Security Scan
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Create results directory
      run: |
        mkdir -p kics-results
        echo "Created kics-results directory"
        ls -la
    
    - name: Run KICS Scan
      id: kics-scan
      continue-on-error: true
      uses: checkmarx/kics-github-action@v1.7.0
      with:
        path: '.'
        output_path: 'kics-results'
        output_formats: 'json,sarif,html'
        fail_on: 'high,medium'
        enable_comments: true
        exclude_paths: '.git,node_modules,*.md,*.txt,tools,kics-results,venv,__pycache__,.pytest_cache'
        platform_type: 'Terraform,CloudFormation,Dockerfile,Ansible,Python'
        cloud_provider: 'aws'
        verbose: true
        ignore_on_exit: 'results'
        include_queries: 'python,secrets,dockerfile,terraform,cloudformation'
    
    - name: Check KICS scan status and create fallback results
      if: always()
      run: |
        echo "KICS scan step outcome: ${{ steps.kics-scan.outcome }}"
        echo "KICS scan conclusion: ${{ steps.kics-scan.conclusion }}"
        
        # Ensure results directory exists
        mkdir -p kics-results
        
        # Create a minimal results file if none exists
        if [ ! -f "kics-results/results.json" ]; then
          echo "Creating fallback results.json"
          cat > kics-results/results.json << 'EOF'
        {
          "files_scanned": 0,
          "queries_total": 0,
          "severity_counters": {
            "HIGH": 0,
            "MEDIUM": 0,
            "LOW": 0,
            "INFO": 0
          },
          "scan_status": "failed_or_no_results",
          "message": "KICS scan did not produce results or failed to execute"
        }
        EOF
        fi
        
        # Create minimal SARIF if none exists
        if [ ! -f "kics-results/results.sarif" ]; then
          echo "Creating fallback results.sarif"
          cat > kics-results/results.sarif << 'EOF'
        {
          "version": "2.1.0",
          "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
          "runs": [
            {
              "tool": {
                "driver": {
                  "name": "KICS",
                  "informationUri": "https://kics.io/",
                  "version": "unknown"
                }
              },
              "results": [],
              "invocations": [
                {
                  "executionSuccessful": false,
                  "toolExecutionNotifications": [
                    {
                      "level": "error",
                      "message": {
                        "text": "KICS scan failed or produced no results"
                      }
                    }
                  ]
                }
              ]
            }
          ]
        }
        EOF
        fi
        
        # Create basic HTML report if none exists
        if [ ! -f "kics-results/results.html" ]; then
          echo "Creating fallback results.html"
          cat > kics-results/results.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head><title>KICS Scan Results</title></head>
        <body>
        <h1>KICS Security Scan Results</h1>
        <p><strong>Status:</strong> Scan failed or produced no results</p>
        <p>Please check the GitHub Actions logs for more details.</p>
        </body>
        </html>
        EOF
        fi
        
    - name: List scan results
      if: always()
      run: |
        echo "Contents of kics-results directory:"
        ls -la kics-results/ || echo "kics-results directory not found"
        echo "File sizes:"
        du -h kics-results/* 2>/dev/null || echo "No files in results directory"
        echo "Current directory contents:"
        ls -la
        echo "Looking for results files anywhere:"
        find . -name "results.*" -type f 2>/dev/null || echo "No results files found"
        
    - name: Upload KICS results to GitHub Security tab
      if: always() && hashFiles('kics-results/results.sarif') != ''
      uses: github/codeql-action/upload-sarif@v3
      continue-on-error: true
      with:
        sarif_file: kics-results/results.sarif
        
    - name: Show SARIF upload status
      if: always()
      run: |
        if [ -f "kics-results/results.sarif" ]; then
          echo "SARIF file exists and will be available in artifacts"
          echo "File size: $(wc -c < kics-results/results.sarif) bytes"
          if [ "${{ steps.kics-scan.outcome }}" != "success" ]; then
            echo "Note: SARIF upload may contain fallback data due to scan issues"
          fi
        else
          echo "No SARIF file found for upload"
        fi
        
    - name: Archive KICS results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kics-security-results-${{ github.run_number }}
        path: kics-results/
        retention-days: 30
        if-no-files-found: warn
        
    - name: Comment PR with results summary
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const results = JSON.parse(fs.readFileSync('kics-results/results.json', 'utf8'));
            
            let statusIcon = '✅';
            let statusText = 'SUCCESS';
            
            if (results.scan_status === 'failed_or_no_results') {
              statusIcon = '⚠️';
              statusText = 'SCAN ISSUES';
            } else if ((results.severity_counters?.HIGH || 0) > 0 || (results.severity_counters?.MEDIUM || 0) > 0) {
              statusIcon = '🔴';
              statusText = 'ACTION REQUIRED';
            }
            
            const summary = `
            ## ${statusIcon} KICS Security Scan Results - ${statusText}
            
            - **High Severity**: ${results.severity_counters?.HIGH || 0}
            - **Medium Severity**: ${results.severity_counters?.MEDIUM || 0}
            - **Low Severity**: ${results.severity_counters?.LOW || 0}
            - **Info**: ${results.severity_counters?.INFO || 0}
            
            **Total Files Scanned**: ${results.files_scanned || 0}
            **Total Queries Executed**: ${results.queries_total || 0}
            
            ${results.scan_status === 'failed_or_no_results' ? 
              '⚠️ **Scan Issues Detected**: The KICS scan encountered problems. Please check the workflow logs and artifacts for details.' :
              (results.severity_counters?.HIGH > 0 || results.severity_counters?.MEDIUM > 0 ? 
                '🔴 **Action Required**: High or Medium severity issues found. Please review the security findings.' : 
                '✅ **No critical security issues found**')
            }
            
            📊 [View detailed results in Actions artifacts](${context.payload.pull_request.html_url}/checks)
            `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
          } catch (error) {
            console.log('Could not parse KICS results or create comment:', error.message);
            
            // Create fallback comment
            const fallbackSummary = `
            ## ⚠️ KICS Security Scan - Unable to Parse Results
            
            The KICS security scan completed, but the results could not be parsed.
            This may indicate scan issues or unexpected output format.
            
            Please check the [workflow run artifacts](${context.payload.pull_request.html_url}/checks) for raw results.
            
            Error: \`${error.message}\`
            `;
            
            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: fallbackSummary
              });
            } catch (commentError) {
              console.log('Failed to create fallback comment:', commentError.message);
            }
          }
        
    - name: Display scan results summary
      if: always()
      run: |
        echo "=========================================="
        echo "KICS Security Scan Results Summary"
        echo "=========================================="
        
        if [ -f "kics-results/results.json" ]; then
          echo "✓ JSON results file found"
          
          # Extract key metrics using basic shell tools
          if command -v jq >/dev/null 2>&1; then
            SCAN_STATUS=$(jq -r '.scan_status // "unknown"' kics-results/results.json)
            echo "Scan status: $SCAN_STATUS"
            echo "Files scanned: $(jq -r '.files_scanned // "N/A"' kics-results/results.json)"
            echo "Queries executed: $(jq -r '.queries_total // "N/A"' kics-results/results.json)"
            echo ""
            echo "Severity breakdown:"
            echo "  HIGH:   $(jq -r '.severity_counters.HIGH // 0' kics-results/results.json)"
            echo "  MEDIUM: $(jq -r '.severity_counters.MEDIUM // 0' kics-results/results.json)"
            echo "  LOW:    $(jq -r '.severity_counters.LOW // 0' kics-results/results.json)"
            echo "  INFO:   $(jq -r '.severity_counters.INFO // 0' kics-results/results.json)"
            
            HIGH=$(jq -r '.severity_counters.HIGH // 0' kics-results/results.json)
            MEDIUM=$(jq -r '.severity_counters.MEDIUM // 0' kics-results/results.json)
            
            echo ""
            if [ "$SCAN_STATUS" = "failed_or_no_results" ]; then
              echo "⚠️  Scan issues detected - please review workflow logs"
            elif [ "$HIGH" -gt 0 ] || [ "$MEDIUM" -gt 0 ]; then
              echo "🔴 Action required: High or Medium severity issues found"
              echo "   Please review the detailed results in the artifacts"
            else
              echo "✅ No critical security issues found"
            fi
          else
            echo "jq not available, basic file info only:"
            echo "Results file size: $(wc -c < kics-results/results.json) bytes"
          fi
        else
          echo "❌ No JSON results file found"
        fi
        
        echo ""
        echo "Available result files:"
        ls -la kics-results/ 2>/dev/null || echo "No results directory found"
        echo ""
        echo "KICS scan step outcome: ${{ steps.kics-scan.outcome }}"
        echo "=========================================="
